<!DOCTYPE html><html><head><meta charset="UTF-8"><style type="text/css">html {overflow:hidden}
body {font-size:10pt;color:#000000;font-family:Arial,Verdana,Helvetica;background-color:white;margin:0px;padding:0px}
table {border-collapse: collapse}
td {padding: 0px}
</style></head><body onload="initPayment()"><div id="border" style="font-family:Verdana,Arial,Helvetica;padding:5px 6px 5px 6px;color:white;background:#306754;width:438px">&nbsp;</div><div id="activity" style="padding:5px 6px 5px 6px">Initializing...</div><div id="content" style="overflow-y:auto;"></div><div id="control" style="z-index:3;position:absolute;bottom:0px;width:450px;padding-top:5px;padding-bottom:10pt"><input id="cancel" type="button" value="&nbsp;Cancel&nbsp;" style="position:relative;visibility:hidden" onclick="userAbort()"><input id="ok" type="button" value="OK" style="position:relative;visibility:hidden" title="Authorize Payment!" onclick="userAuthorize()"></div><img id="busy" src="images/loading.gif" alt="html5 requirement..." style="position:absolute;top:101px;left:201px;z-index:5;visibility:visible;"/><script type="text/javascript">
"use strict";

////////////////////////////////////////////////////////////////////
// Disclaimer: The actual messages used by this payment provider  //
// in no way represents a standard or a standards proposal.       //
// However, the message flow is anticipated to be usable "as is". //
////////////////////////////////////////////////////////////////////

var aborted_operation = false;
var timeouter_handle = null;
var amount_to_pay;
var currency;
var caller_common_name;
var payment_state = 'INIT';
var button_width;
var webpki = {};
webpki.CardEntry = function(base64_image, type, pin, pan) {
    this.base64_image = base64_image;
    this.type = type;
    this.pin = pin;
    this.pan = pan;
    this.matching = false;
};
var card_list = [];
card_list[0] = new webpki.CardEntry('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', 'SUPER_CARD', '1234', '2323909700277532');
card_list[1] = new webpki.CardEntry('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', 'COOL_CARD', '1234', '0793977303560935');
card_list[2] = new webpki.CardEntry('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', 'UNUSUAL_CARD', '1234', '8595357203651726');

function bad(message) {
    console.debug ('Bad: ' + message);
    if (!aborted_operation) {
        document.getElementById('activity').innerHTML='ABORTED:<br>' + message;
        aborted_operation = true;
    }
    document.getElementById('busy').style.visibility = 'hidden';
}

function checkNoErrors() {
   if (aborted_operation || window.self.innerWidth != 450 || window.self.innerHeight != 250) {
       bad('Frame size manipulated by parent');
       return false;
   }
   if (!card_list.length) {
       bad('You appear to have no payment cards at all, please return to the <b>Payment&nbsp;Demo&nbsp;Home</b> and get some!  It\'s free :-)');
       return false;
   }
   return true;
}

function checkTiming(milliseconds) {
   timeouter_handle = setTimeout(function () {bad('Timeout')}, milliseconds);
}

function checkState(event) {
    var json = JSON.parse(event.data);
    if (json.Command != payment_state) {
        bad('State error:' + payment_state + '<>' + event.data);
        return null;
    }
    return json;
}

function priceString(price_mult_100) {
    return '$' +  Math.floor(price_mult_100 / 100) + '.' +  Math.floor((price_mult_100 % 100) / 10) +  Math.floor(price_mult_100 % 10);
}

function createJSONBaseCommand(command_property_value) {
    var json = {};
    json.Command = command_property_value;
    return json;
}

function getJSONPropertyValue(json, property) {
    var value = json[property];
    console.debug(property + ': ' + value);
    if (value === undefined) {
        bad('Missing property: ' + property);
        return null;
    }
    return value;
}

function cardTableHeader(right_margin, top_margin) {
    return '<table style="margin-left:auto;margin-right:' + right_margin + ';margin-top:' + top_margin + 'px">';
}

function outputCard(card_index, add_on) {
    return '<td>' + '<div style="padding:0px;margin-left:auto;margin-right:auto;width:150px;height:80px;border-radius:8px;border-width:1px;border-style:solid;border-color:#B0B0B0;box-shadow:3px 3px 3px #D0D0D0;background-image:url(\'data:image/png;base64,' + card_list[card_index].base64_image + '\')' + add_on + '"></div></td>';
}

//
// Although PANs (card numbers) are not really needed from the user's
// point of view, they represent a legacy which should not be ignored...
//
function outputPAN(card_index) {
    var pan_html = '<td style="padding-top:5px;padding-bottom:10px;font-size:8pt;font-family:Verdana,\'Bitstream Vera Sans\',\'DejaVu Sans\',Arial;text-align:center">';
    var pan = card_list[card_index].pan;
    for (var i = 0; i < pan.length; i++) {
        if (i && i % 4 == 0) pan_html += ' ';
        pan_html += pan.charAt(i);
    }
    return pan_html + '</td>';
}

//
// This is the core display where the user authorizes the
// actual payment process.
//
function displayPaymentRequest(card_index) {
    var payment_details = '<table id="details" style="position:absolute;text-align:center"><tr><td>Requester: ' + caller_common_name + '</td></tr><tr><td style="padding-top:10pt;padding-bottom:10pt">Amount: ' + priceString(amount_to_pay) + '</td></tr><tr><td>PIN: <input id="pin" style="font-family:Verdana,Arial;letter-spacing:2px;background-color:#f0f0f0" type="password" size="8" maxlength="20"></td></tr><table>';
    document.getElementById('activity').innerHTML = '&nbsp;';
    document.getElementById('cancel').style.left = '15px';
    document.getElementById('content').innerHTML = payment_details + cardTableHeader('30px', 25) + '<tr>' + outputCard(card_index, '" title="Don\'t leave home without it!') + '</tr><tr>' + outputPAN(card_index) + '</tr></table>';
    document.getElementById('details').style.top = (250 - document.getElementById('details').offsetHeight)/2 + 'px';
    var details_left = document.getElementById('details').style.left = (270 - document.getElementById('details').offsetWidth) / 2;
    document.getElementById('details').style.left = details_left + 'px';
    document.getElementById('ok').style.left = ((details_left + document.getElementById('pin').offsetLeft - button_width) * 2 + document.getElementById('pin').offsetWidth - 15) + 'px';
    document.getElementById('ok').style.visibility = 'visible';
    document.getElementById('pin').title = 'Forgot PIN? Try with ' + card_list[card_index].pin + ' :-)';
    document.getElementById('pin').focus();
}

//
// Displays payee compatible cards for the user to select from.
// If the card collection does not fit in payment window,
// a scrollable view is created.
//
function displayCompatibleCards(count) {
    document.getElementById('activity').innerHTML = 'Select Card';
    var left_card = true;
    var previous_card;
    var cards = cardTableHeader('auto', count < 3 ? 25 : 0);
    for (var q = 0; q < card_list.length; q++) {
        if (card_list[q].matching) {
            cards += left_card ? '<tr>' : '<td style="width:20px"></td>';
            cards += outputCard(q, ';cursor:pointer" title="Click to select" onclick="displayPaymentRequest(' + q + ')');
            cards += left_card ? '' : '</tr>';
            if (left_card = !left_card) {
                cards += '<tr>' + outputPAN(previous_card) + '<td></td>' + outputPAN(q) + '</tr>';
            }
            previous_card = q;
        }
    }
    if (!left_card) {
        cards += '<td colspan="2" rowspan="2"></td><tr>' + outputPAN(previous_card) + '</tr>';
    }
    document.getElementById('content').innerHTML = cards + '</table>';
}

//
// Terminates the payment session in case of a user abort.
//
function userAbort() {
    document.getElementById('activity').innerHTML = 'Aborting...';
    document.getElementById('content').innerHTML = '';
    document.getElementById('busy').style.visibility = 'visible';
    window.parent.postMessage(JSON.stringify(createJSONBaseCommand ('ABORT')), window.document.referrer);
}

//
// Called when the user authorized the payment.
//
function userAuthorize() {
    document.getElementById('busy').style.visibility = 'visible';
    alert ('not implemented');
}

//
// Processes the payee's JSON response to the INIT message.
//
// Message syntax:
//   {
//     "Command": "INIT"
//     "Amount": nnnn                   Integer of the payment sum multiplied by 100
//     "Currency": "USD"                Currently the only recognized
//     "CommonName": "Name"             Common name of requester
//     "CardTypes": ["Card Type"...]    1-n card types recognized by the payee
//   }
//
function processINIT(received_json) {
    caller_common_name = getJSONPropertyValue(received_json, 'CommonName');
    amount_to_pay = getJSONPropertyValue(received_json, 'Amount');
    currency = getJSONPropertyValue(received_json, 'Currency');
    var payee_card_types = getJSONPropertyValue(received_json, 'CardTypes');
    if (aborted_operation) return;
    // Perform the card compatibility/discovery processes
    var count = 0;
    for (var q = 0; q < payee_card_types.length; q++) {
        for (var i = 0; i < card_list.length; i++) {
            if (payee_card_types[q] == card_list[i].type) {
                console.debug('Compatible Card: "' + payee_card_types[q] + '"');
                card_list[i].matching = true;
                count++;
            }
        }
    }
    document.getElementById('content').style.height = (252 - document.getElementById('control').offsetHeight - document.getElementById('border').offsetHeight - document.getElementById('activity').offsetHeight) + 'px';
    button_width = document.getElementById('cancel').offsetWidth;
    document.getElementById('ok').style.width = button_width + 'px';
    document.getElementById('cancel').style.left = ((450 - button_width) / 2) + 'px';
    document.getElementById('cancel').title = 'Cancel and return to "' + caller_common_name + '"';
    document.getElementById('cancel').style.visibility = 'visible';
    if (!count) {
        bad('No matching payment cards found, click "Cancel" to return to "' + caller_common_name + '".');
        return;
    }
    if (count == 1) {
        // Shortcut: If there is only one matching card we
        // might as well go to the payment display directly.
        for (var q = 0; q < card_list.length; q++) {
            if (card_list[q].matching) {
                displayPaymentRequest(q);
                return;
            }
        }
    } else {
        displayCompatibleCards(count);
    }
}

//
// The payment application always query the payee for data.
// There is a timeout associated each request.
//
function receivePayeeResponse(event) {
    console.debug(event.origin);
    console.debug(event.data);
    if (aborted_operation) return;
    if (timeouter_handle) {
        clearTimeout(timeouter_handle);
        timeouter_handle = null;
        var received_json = checkState(event)
        if (!received_json) return;
        document.getElementById('busy').style.visibility = 'hidden';
        if (payment_state == 'INIT') {
            processINIT(received_json);
        }
    } else {
        bad('Unexpected message :' + event.origin + ' ' + event.data);
    }
}

//
// When the payment module IFRAME has been loaded (by the payee),
// the payment process is automatically invoked by the body.onload().
//
function initPayment() {
    var caller_domain = window.document.referrer;
    caller_domain = caller_domain.substring(caller_domain.indexOf('://') + 3);
    if (caller_domain.indexOf(':') > 0) {
        caller_domain = caller_domain.substring(0, caller_domain.indexOf(':'));
    }
    if (caller_domain.indexOf('/') > 0) {
        caller_domain = caller_domain.substring(0, caller_domain.indexOf('/'));
    }
    document.getElementById('border').innerHTML = 'Payment Request [' + caller_domain + ']';
    if (checkNoErrors()) {
        window.addEventListener('message', receivePayeeResponse, false);
        checkTiming(5000);
        console.debug('init payment window');
        window.parent.postMessage(JSON.stringify(createJSONBaseCommand ('INIT')), window.document.referrer);
    }
}
</script></body></html>