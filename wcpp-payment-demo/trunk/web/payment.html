<!DOCTYPE html><html><head><meta charset="UTF-8"><style type="text/css">html {overflow:hidden}
body {font-size:8pt;color:#000000;font-family:verdana,arial;background-color:white;margin:0px;padding:0px}
table {border-collapse: collapse}
td {padding: 0px}
</style></head><body onload="initPayment()"><div id="border" style="padding:5px 6px 5px 6px;color:white;font-size:10pt;background:#306754;width:438px">Payment Request</div><div id="activity" style="padding:5px 6px 5px 6px">Initializing...</div><div id="content" style="overflow-y:auto;"></div><div id="control" style="font-size:10pt;z-index:3;position:absolute;bottom:0px;width:450px;padding-top:5px;padding-bottom:10pt"><input type="button" value="Cancel" id="cancel" style="position:relative;visibility:hidden"><input type="button" value="OK" id="ok" style="position:relative;visibility:hidden"></div><img id="busy" src="images/loading.gif" alt="html5 requirement..." style="position:absolute;top:101px;left:201px;z-index:5;visibility:visible;"/><script type="text/javascript">

//////////////////////////////////////////////////////////////////
// Disclaimer: The message syntax used by this payment provider //
// in no way represents a standard or a standards proposal.     //
//////////////////////////////////////////////////////////////////

var aborted_operation = false;
var timeouter_handle = null;
var payment_state = 'INIT';
CardEntry = function(base64_image, type, pin, pan) {
    this.base64_image = base64_image;
    this.type = type;
    this.pin = pin;
    this.pan = pan;
    this.matching = false;
};
var card_list = [];
card_list[0] = new CardEntry ('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', 'SUPER', '1234', '2815310632907810');
card_list[1] = new CardEntry ('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', 'COOL', '1234', '5041401156042329');

function bad(message) {
    if (!aborted_operation) {
        document.getElementById('activity').innerHTML='ABORTED:<br>' + message;
        aborted_operation = true;
    }
    document.getElementById('busy').style.visibility = 'hidden';
}

function checkNoErrors() {
   if (aborted_operation || window.self.innerWidth != 450 || window.self.innerHeight != 250) {
       bad('Frame size manipulated by parent');
       return false;
   }
   if (!card_list.length) {
       bad('You appear to have no payment cards at all, please return to the Payment Demo Home and get some!');
       return false;
   }
   return true;
}

function checkTiming(milliseconds) {
   timeouter_handle = setTimeout(function () {bad('Timeout')}, milliseconds);
}

function checkState(event) {
    if (event.data.indexOf(payment_state)) {
        bad('State error:' + payment_state + '<>' + event.data);
        return null;
    }
    if (event.data.length < (payment_state.length + 2) || event.data.charAt(payment_state.length) != '=') {
        bad('Missing argument: ' + event.data);
        return null;
    }
    return event.data.substring(payment_state.length + 1);
}

function cardTableHeader(right_margin, top_margin) {
    return '<table style="margin-left:auto;margin-right:' + right_margin + ';margin-top:' + top_margin + 'px">';
}

function outputCard(card_index, add_on) {
    return '<td>' + '<div style="padding:0px;margin-left:auto;margin-right:auto;width:150px;height:80px;border-radius:8px;border-width:1px;border-style:solid;border-color:#B0B0B0;box-shadow:3px 3px 3px #D0D0D0;background-image:url(\'data:image/png;base64,' + card_list[card_index].base64_image + '\')' + add_on + '"></div></td>';
}

//
// Although PANs (card numbers) are not really needed from the user's
// point of view, they represent a legacy which should not be ignored...
//
function outputPAN(card_index) {
    var pan_html = '<td style="padding-top:5px;padding-bottom:10px;text-align:center">';
    var pan = card_list[card_index].pan;
     for (var i = 0; i < pan.length; i++) {
        if (i && i % 4 == 0) pan_html += ' ';
        pan_html += pan.charAt(i);
    }
    return pan_html + '</td>';
}

//
// This is the core display where the user authorizes the
// actual payment process.
//
function displayPaymentRequest(card_index) {
    document.getElementById('activity').innerHTML = 'Pay Display (TBD)';
    document.getElementById('ok').style.visibility = 'visible';
    document.getElementById('cancel').style.left = '10px';
    document.getElementById('content').innerHTML = cardTableHeader('30px', 25) + '<tr>' + outputCard(card_index, '') + '</tr><tr>' + outputPAN(card_index) + '</tr></table>';
}

//
// Displays payee compatible cards for the user to select from.
// If the card collection does not fit in payment window,
// a scrollable view is created.
//
function displayCompatibleCards(count) {
    document.getElementById('activity').innerHTML = 'Select Card';
    document.getElementById('cancel').style.left = ((450 - document.getElementById('cancel').offsetWidth) / 2) + 'px';
    var left_card = true;
    var previous_card;
    var cards = cardTableHeader('auto', count < 3 ? 25 : 0);
    for (var q = 0; q < card_list.length; q++) {
        if (card_list[q].matching) {
            cards += left_card ? '<tr>' : '<td style="width:20px"></td>';
            cards += outputCard(q, ';cursor:pointer" title="Click to select" onclick="displayPaymentRequest(' + q + ')');
            cards += left_card ? '' : '</tr>';
            if (left_card = !left_card) {
                cards += '<tr>' + outputPAN(previous_card) + '<td></td>' + outputPAN(q) + '</tr>';
            }
            previous_card = q;
        }
    }
    if (!left_card) {
        cards += '<td colspan="2" rowspan="2"></td><tr>' + outputPAN(previous_card) + '</tr>';
    }
    document.getElementById('content').innerHTML = cards + '</table>';
}

//
// Processes the payee's response to the INIT message.
//
// Message syntax:
//   Amount           Integer of the payment sum multipled by 100
//   {@CardType}...   1-n card types recognized by the payee
//
function processINIT(response) {
    var amount = response.substring(0, response.indexOf('@'));
    console.debug('Amount: ' + amount);
    var count = 0;
    while (response.indexOf('@') >= 0) {
        response = response.substring (response.indexOf('@') + 1);
        var i = response.indexOf('@');
        card = i > 0 ? response.substring(0, i) : response;
        console.debug('Card: "' + card + '"');
        for (i = 0; i < card_list.length; i++) {
            if (card == card_list[i].type) {
                card_list[i].matching = true;
                count++;
            }
        }
    }
    if (!count) {
        bad('No matching payment card found!');
        return;
    }
    document.getElementById('content').style.height = (252 - document.getElementById('control').offsetHeight - document.getElementById('border').offsetHeight - document.getElementById('activity').offsetHeight) + 'px';
    document.getElementById('ok').style.width = document.getElementById('cancel').offsetWidth + 'px';
    document.getElementById('cancel').style.visibility = 'visible';
    if (count == 1) {
        // Shortcut: If there is only one matching card we
        // might as well go to the payment display directly.
        for (var q = 0; q < card_list.length; q++) {
            if (card_list[q].matching) {
                displayPaymentRequest(q);
                return;
            }
        }
    } else {
        displayCompatibleCards(count);
    }
}

//
// The payment module always query the payee for data.
// There is an abort timeout associated each request.
//
function receivePayeeResponse(event) {
    console.debug(event.origin);
    console.debug(event.data);
    if (aborted_operation) return;
    if (timeouter_handle) {
        clearTimeout(timeouter_handle);
        timeouter_handle = null;
        var response = checkState(event)
        if (!response) return;
        document.getElementById('busy').style.visibility = 'hidden';
        if (payment_state == 'INIT') {
            processINIT(response);
        }
    } else {
        bad('Unexpected message :' + event.origin + ' ' + event.data);
    }
}

//
// When the payment module IFRAME has been loaded (by the payee),
// the payment process is automatically invoked by the body.onload().
//
function initPayment() {
    if (checkNoErrors()) {
        window.addEventListener('message', receivePayeeResponse, false);
        checkTiming(5000);
        console.debug('init payment window');
        window.parent.postMessage('INIT', window.document.referrer);
   }
}
</script></body></html>