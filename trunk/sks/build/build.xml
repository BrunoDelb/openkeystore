<project name="WEBPKI.ORG SKS" default="dist" basedir=".">

  <!-- set global properties for this build -->
  <property name="src_dir" value="../src" />
  <property name="temp_dir" value="../.tmp" />
  <property name="dist_dir"  value="../dist" />
  <property name="library_dir" value="../../library"/>
  <property name="resource_dir" value="../../resources"/>
  <property name="hlca" value="webpki.org-hlca-1.00.jar" />
  <property name="sks_dbemulator" value="webpki.org-sks-dbemulator-1.00.jar" />
  <property name="sks_hwdevice" value="webpki.org-sks-hwdevice-1.00.jar" />
  <property name="sks_softtoken" value="webpki.org-sks-softtoken-1.00.jar" />
  <property name="doc_dir"  value="../doc" />
  <property name="debug"  value="on"/>
  <property environment="env"/>
  <property name="secret.file" location="../../non-public/mysys.prop"/>
  <property file="${secret.file}"/>
  <condition property="java_root_set">
    <isset property="env.JAVA_HOME"/>
  </condition>
  <fail message="JAVA_HOME must be set to environment!" unless="java_root_set"/>

  <path id="compile.classpath">
    <fileset dir="${library_dir}/dist">
      <include name="webpki.org-libext*.jar"/>
    </fileset>
    <fileset dir="${resource_dir}/third-party-jars">
      <include name="bcprov*.jar"/>
    </fileset>
  </path>

  <target name="help">
    <echo message="Available targets are help, clean, compile and doc."/>
  </target>

  <target name="compile">
    <fixcrlf srcdir="${src_dir}"
       tab="remove"
       tablength="4"
       eol="lf"
       eof="remove"
       includes="**/*.java, **/*.xsd"/>
    <!-- Compile the java code from ${src_dir} into ${temp_dir} -->
    <mkdir dir="${temp_dir}" />
    <javac srcdir="${src_dir}" debug="${debug}" destdir="${temp_dir}" classpathref="compile.classpath">
      <include name="org/**/softtoken/*"/>
  	  <include name="org/**/hlca/test/*"/>
  	  <include name="org/**/JCE*"/>
	  <include name="org/**/Digester*"/>
      <compilerarg value="-Xlint"/>
    </javac>
    <!-- Copy all files except .java  -->
    <copy todir="${temp_dir}" preservelastmodified="true">
      <fileset dir="${src_dir}">
        <include name="org/**/*"/>
        <exclude name="org/**/*.java"/>
        <exclude name="org/**/package.html"/>
        <exclude name="org/**/doc-files/*"/>
      </fileset>
    </copy>

    <!-- Create the distribution directory -->
    <mkdir dir="${dist_dir}" />

    <!-- Put everything from ${temp_dir} into the two jar files -->
	<jar jarfile="${dist_dir}/${hlca}">
		<fileset dir="${temp_dir}">
		    <include name="org/webpki/hlca/**"/>
		</fileset>
	</jar>
	<signjar jar="${dist_dir}/${hlca}" alias="jcesign" storepass="${sign.pwd}" keypass="${sign.pwd}" keystore="${sign.cert}"/>
  	
    <jar jarfile="${dist_dir}/${sks_softtoken}">
      <fileset dir="${temp_dir}">
          <include name="org/webpki/sksimpl/softtoken/**"/>
      </fileset>
      <zipfileset dir="../../library/src/org/webpki/sks/test" includes="attestationkeystore.jks" prefix="org/webpki/sksimpl/softtoken"/>
      <service type="org.webpki.sks.SecureKeyStore" provider="org.webpki.sksimpl.softtoken.SKSReferenceImplementation"/>
    </jar>
  	
    <jar jarfile="${dist_dir}/${sks_dbemulator}">
      <fileset dir="${temp_dir}">
          <include name="org/webpki/sks/dbemulator/**"/>
      </fileset>
      <zipfileset dir="../../resources/keygen2-certificates" includes="deviceca.jks" prefix="org/webpki/sks/dbemulator"/>
      <service type="org.webpki.sks.SecureKeyStore" provider="org.webpki.sks.dbemulator.SKSEmulator"/>
    </jar>
  	
    <jar jarfile="${dist_dir}/${sks_hwdevice}">
      <fileset dir="${temp_dir}">
        <include name="org/webpki/sks/hwdevice/**"/>
        <include name="org/webpki/io/**"/>
      </fileset>
      <service type="org.webpki.sks.SecureKeyStore" provider="org.webpki.sks.hwdevice.SKSHardwareDriver"/>
  	  <manifest>
  	      <attribute name="Main-Class" value="org.webpki.io.serial.SerialDeviceDriver"/>
  	  </manifest>
    </jar>
  </target>

  <target name="doc">
    <!-- Create the distribution directory -->
    <mkdir dir="${doc_dir}" />

    <!-- Make documentation -->
    <javadoc destdir="${doc_dir}"
             author="true"
             version="true"
             Package="false"
             Use="false"
             nodeprecated="true"
             nodeprecatedlist="true"
             windowtitle="WebPKI.org Phone JCE">
      <packageset dir="${src_dir}">
        <include name="org/**"/>
        <exclude name="org/**/test/**"/>
      </packageset>
      <link offline="true" href="http://java.sun.com/j2se/1.5.0/docs/api/" packagelistLoc="${env.JAVA_HOME}\docs\api"/>
      <doctitle><![CDATA[<h1>WebPKI.org Phone SKS</h1>]]></doctitle>
      <bottom><![CDATA[<i>2006-2009 WebPKI.org</i>]]></bottom>
    </javadoc>
  </target>
  
  <target name="clean">
	    <delete dir="${temp_dir}"/>
	    <delete dir="${dist_dir}"/>
  </target>
	
  <target name="dist" depends="clean,compile"/>

</project>
